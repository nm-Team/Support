# nmBot 2023 年 4 月功能更新

亲爱的用户，您期盼已久的 nmBot 功能更新现已推出。
本更新推出了群组加权发言频率限制功能，为入群验证、关键词回复等群组功能推出了全新升级，还为 nmBot 积分功能推出了群组开关。本更新还包含错误修复和稳定性提升。

## 2023 年 4 月 12 日 13:10
nmBot 版本号：23.4.1

- 修复了入群验证消息和封禁骚扰用户的提示消息中，“解除封禁并加入白名单”按钮无法正常使用的问题。
- 更新了 nmBot 消息处理模块底层的部分实现，以尝试解决线上极少数消息的运行数据异常丢失的问题。
- 精简了 nmBot 运行日志内容。

## 2023 年 4 月 11 日 20:00

### 加权发言频率限制
- 新增“加权发言频率限制”功能：nmBot 将在群成员每分钟内发送消息超过一定限制时限制成员在一分钟内继续发言。
    - 群组管理员还可以为不同类型的消息设置权重。例如，若群组管理员将媒体权重设置为 2，则成员每发送一条媒体消息相当于发送 2 条其他消息。
    - 群组管理员还可以设置是否要将媒体组视为一条消息。
    - 该功能可在 nmBot /config 菜单和 nmBot 面板设置。

### 入群验证大优化
- 新增可选的入群验证方式：
    - 发送贴纸验证：nmBot 授予用户发送贴纸权限，用户可发送一张贴纸来完成验证。用户可能需要较新的 Telegram 版本才能完成验证。
- nmBot 入群验证支持跳转到私信验证。
- 入群验证消息中“通过”“拒绝”和“拒绝并举报骚扰”选项将不再显示“管理员”提示文本，并在同一行中显示。
- 入群验证模式设置为跳转到私信验证时，入群欢迎将在私信中发送，并且将不会自动删除。
- 入群验证设置新增选项“封禁退出群组的用户”。
- 若新成员在自入群验证消息发送 2 秒前起至入群验证完成止的时间段内发送了消息，且该消息的发送非入群验证要求，nmBot 将删除该消息，并提示用户在完成入群验证后再发送消息。（因技术原因，删除消息有约 2 秒的延迟。）
- 匿名管理员拒绝新成员入群时，提示信息中将不再显示匿名管理员的信息。
- nmBot /config 菜单中，入群验证设置页面的部分选项调整为双栏显示。

### 关键词回复更强大
- 关键词回复新增匹配文本内容设置：可以设置触发关键词回复的文本类型。目前可供设置的类型有：消息文本和媒体描述、文件名、贴纸 Emoji、贴纸包名称。
- 关键词回复新增选项“匹配编辑后的消息”。启用后，nmBot 将在消息内容被编辑后，再次匹配关键词。此前匹配关键词所进行的操作不会被撤销。
- 关键词回复新增选项“禁用链接预览”。启用后，在回复内容中插入链接时，发送的回复消息中，将不会显示链接预览。该选项可在 nmBot 面板的关键词回复设置中设置。
- 关键词回复新增选项“同时匹配简体和繁体”。启用后，成员在发送消息时，无论采取简体写法或繁体写法，均可触发关键词回复。
- 关键词回复新增选项“忽略英文字母大小写”。启用后，成员在发送消息时，无论发送的英文字母是大写还是小写，均可触发关键词回复。
- 关键词回复新增选项“禁用 nmartChat”。启用“禁用 nmartChat”后，成员在回复关键词回复消息时，不会触发 nmartChat。
- nmBot 面板关键词回复和入群欢迎编辑页面中回复内容新增全屏编辑功能：用户可以通过全屏按钮打开一个全屏专业编辑器来编辑关键词回复的关键词和回复内容和入群欢迎。
    - 高级编辑器可能不支持移动设备和触屏。
- 在 nmBot 面板编辑关键词回复时，关键词设置输入框现在更大，并且支持自动换行。
- 用户首次在 nmBot 面板编辑关键词回复时，页面将向下滚动并在稍后滚回顶部，并显示提示，提示用户可以向下滚动来修改更多关键词回复设置。
- 为 nmBot 面板关键词回复和入群欢迎编辑页面中回复内容编辑框限制了最小高度。
- 新增关键词回复的回复内容解析方式“无”，即不以任何方式解析关键词回复的回复内容。
- 本次更新后，关键词回复的默认内容解析方式调整为“无”。由于此更改，2022 年 7 月 8 日 00:13 前创建的关键词回复的回复内容解析方式可能会变更为“无”，群组管理员可以在 nmBot 面板重新调整回复内容解析方式。
- 关键词回复拷贝消息失败时，新增了相应的错误提示。

### 同频气氛组可选语气 (Beta)
- 为“同频气氛组”功能推出了语气设置选项：群组管理员可以设置“同频气氛组”功能的语气。
- 此版本中可设置的“同频气氛组”语气有：随机 (默认)、称赞 (Beta)、讽刺、热情 (Beta)、猫娘 (Beta)。更新后，群组默认的“同频气氛组”语气为随机 (默认)。
- 新版“同频气氛组”体验面向所有使用 nmBot 的群组推出。该功能可在 nmBot /config 菜单和 nmBot 面板设置。

### 指令运用更随心
- 新增 /whatis 指令来查询 nmBot 可用指令的详情。

### nmBot 面板偏好设置
- 在 nmBot 面板新增了“偏好设置”设置页面。页面中目前包含的设置内容如下：
    - 自定义缩放比例：自定义 nmBot 面板字体、图标和按钮的大小。
    - 禁用动画效果：禁用 nmBot 面板中的动画效果。
    - 显示更多直角元素 (Beta)：将部分页面元素替换为直角设计，并减少部分圆角元素的边距。
    - 启用滑动返回：在触屏设备上，从左到右滑动来返回上一页面。

### 积分记录开关
- 为 nmBot 积分功能推出独立设置：群组管理员可以在 nmBot /config 菜单和 nmBot 面板启用或关闭积分功能；关闭积分功能后，签到指令和积分查询指令将无法使用，成员在群组中发送消息也不会增加积分。

### Telegram 机器人信息适配
- 新增 /settings 和 /privacy 指令帮助用户了解 nmBot 的设置方法和隐私政策。用户也会在 nmBot 的机器人信息页面中看到“机器人设置”和“机器人隐私政策”选项。

### 其他更新和修复
- 使用 nmBot 的行内功能时，对应功能将显示图标。
- nmBot 面板在双栏模式下显示时，右侧栏空白时，新增了 nmBot 面板主要功能提示。
- 群成员使用“呼叫群组管理员”功能时，若回复了一条消息，群组管理员现在可以直接通过按钮对回复消息执行删除，或对用户执行封禁、举报骚扰等操作。
- 群成员使用“呼叫群组管理员”功能时，若回复了一条消息，发送的消息将回复给群成员回复的消息。
- 匿名管理员现在可以通过 /config 指令打开 nmBot 群组功能设置菜单。
- 骚扰消息过滤器现在支持识别编辑后的消息。
- 具有自定义头衔的匿名管理员使用“群友互动”功能时，其头衔将显示在消息中。
- 多个匿名管理员互相使用“群友互动”功能时，若他们分别拥有不同的自定义头衔，将不再被视为“自己”。
- 以下功能发送的消息中，用户名称现在将被部分隐藏：
    - 启用自动删除入群系统消息，入群验证功能在群组中发送的部分消息。
    - /spam 指令的返回消息。
    - 群成员发送的消息被 nmBot 识别为骚扰消息时，发送的提示消息。
- 使用 /config 指令管理群组设置时，根据打开的不同页面，nmBot 将显示与设置项有关的解释文本。
- 使用 /warn 指令警告或取消警告成员时，返回的消息中现在将提示群组当前设置的警告次数上限。
- /id 功能新增支持显示消息编辑时间。
- 拥有不同自定义头衔的匿名管理员使用 /id 功能查询对方的消息时，nmBot 将同时显示本条消息的基本信息和回复消息的基本信息。
- 管理员对 nmBot 发送的含有用户 ID 识别标签的消息回复 /spam 时，相关操作结果将等效于回复 /block。
- 优化了 nmartChat 和同频气氛组功能的回复效果。
- nmBot /config 菜单中，未选中的选项开头将不再添加空格。
- /help 指令的返回内容调整为与 /doc 指令一致。若要打开旧版 nmBot 帮助，请发送 /help_legacy。
- 旧版 nmBot 帮助中，关于网页版 nmBot 帮助文档的描述文本中不再显示测试字样。
- 在浏览器中打开 nmBot 面板时，nmBot 面板支持在浏览器主题更改时更改页面配色。
- 优化了使用触屏设备时，nmBot 面板滑动返回功能的灵敏度。
- 用户个人名片发送失败时，新增了相应的发送失败提示。
- 通过浏览器直接登录 nmBot 面板时，现在也支持保持登录状态。
- nmBot 面板中，部分无点击事件的设置项框架不再可通过键盘获得焦点。
- nmBot 面板中，鼠标指向部分无点击事件的设置项框架时，框架颜色将不再发生变化。
- nmBot 面板中“更新日志”页面现在显示浏览器菜单。
- nmBot 面板中“帮助文档”选项现在不再显示 Beta 字样。
- 调整了窗口宽度较小时，nmBot 面板的默认缩放比例。
- nmBot 面板群组信息页面的相应信息新增点击拷贝到剪贴板的聚焦提示文本。
- 优化了特定情况下 nmartChat 的触发效果。
- 在 nmBot 运行时与 Telegram 同步指令列表前添加了延迟。
- 对 nmBot 内容本地化做出了如下调整和修复：
    - 部分场景下用于删除 nmBot 消息的按钮文本由“关闭”修改为“好”。
    - 过塑消息时，模板选择消息中，关闭按钮的文本由“关闭”调整为“取消”。
    - /doc 指令的返回消息现在以用户设定的语言显示，且用户设定的语言非简体中文时增加了 nmBot 帮助文档中的内容可能仅以简体中文呈现的提示。
    - 在 nmBot 面板群组信息页面，拷贝信息到剪贴板成功的提示文本中增加了句号或句点。
    - 使用简体中文意外的语言时，在 nmBot 面板设置关键词回复时，相关的错误信息现在支持以设定的语言显示。
    - 修复了使用频道身份时，/panel 指令的返回消息文本中部分内容未正常显示的问题。
    - 修复了使用简体中文和英语时，使用 /warn 和 /unwarn 指令时，无权限提示中部分参数错误的问题。
    - 修复了繁体中文和英文中部分管理员权限无对应本地化文本的问题。
- 修复了使用过塑功能时，被过塑消息发送者为 Telegram 会员时，过塑贴纸的用户名后可能出现星标的问题。
- 修复了使用匿名管理员身份时 /pm 指令无法正常使用的问题。
- 修复了特定情况下，nmBot 的返回消息中将匿名群组身份显示为频道的问题。
- 修复了特定情况下 nmartChat 消息上下文的顺序和发送者匹配错误的问题。
- 修复了新版“同频气氛组”和 nmartChat 体验中，nmBot 回复的消息未正确记录至消息列表的问题。
- 修复了无回复文本并设置了禁言触发者的关键词回复在群组中触发时，发送的提示消息文本存在错误的问题。
- 修复了在 nmBot 面板群组设置中修改“智能识别并删除骚扰消息”某一类别设置后，页面上其他类别的显示状态错误的问题。
- 修复了 nmBot “智能识别并删除骚扰消息”功能删除消息后，点击“封禁用户”或“封禁频道”按钮后按钮无操作完成反馈的问题。
- 修复了 nmBot 发送入群欢迎消息时，新成员名称转义不正确的问题。
- 修复了使用 /warn 指令和 /spam 指令对频道进行操作时，返回消息中可能显示该频道链接预览的问题。
- 修复了使用 /spam 指令时，特定情况下返回消息中的用户名称未转义的问题。
- 修复了举报骚扰处理结果通知未正常对从未在 nmBot 注册管理群组的用户发送的问题。
- 修复了使用 /spam 指令对不含有文本内容的消息举报骚扰时，相关举报实际未正确完成的问题。
- 修复了通过 nmBot 面板修改关键词回复后，操作记录中部分数据记录错误的问题。
- 修复了 nmBot 面板群组操作记录搜索页面中，“按搜索按钮或 Enter 来搜索”提示文本在以两行以上文本显示时，文本对齐效果为左对齐的问题。
- 在 nmBot 行内功能中删除了“讲个笑话”选项。
